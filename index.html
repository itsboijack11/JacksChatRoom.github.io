<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jacks Chat Room</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
  <style>

.active-user {
    font-weight: bold;
    color: lightblue;
  }

  .other-username {
    font-weight: bold;
    color: lightblue;
  }

.user-message {
  font-weight: bold;
  color: black; /* Default for light mode */
}

/* When dark mode is active */
body.dark-mode .user-message {
  color: white;
}
       
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; transition: background 0.3s, color 0.3s; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-top: 10px; }
    #messageInput { width: 70%; }
    .hidden { display: none; }
    .chat-tab { cursor: pointer; padding: 5px; margin-right: 5px; background: #ddd; border-radius: 5px; display: inline-block; }
    .chat-tab.active { background: #bbb; }
    .msg { margin-bottom: 10px; display: flex; align-items: center; }
    .msg img { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
    .time { font-size: 0.8em; color: #777; margin-left: 10px; }
    #typingIndicator { font-style: italic; color: #666; margin-top: 5px; height: 16px; }

    .search-bar-container {
      display: flex;
      justify-content: space-between;
      width: 50%;
      margin: 20px auto;
    }

    #targetUsername {
      flex: 1;
      padding: 5px;
    }
    #startChatButton {
      padding: 5px 10px;
      cursor: pointer;
    }
    #friendsList {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px 0;
    }
    #friendsList li {
      margin-right: 10px;
      list-style: none;
    }
    #friendsList img {
      vertical-align: middle;
    }
    .welcome {
      position: absolute;
      top: 20px;
      left: 20px;
    }
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    body.dark-mode #messages {
      background-color: #1e1e1e;
      border-color: #444;
    }
    body.dark-mode input,
    body.dark-mode button {
      background-color: #2c2c2c;
      color: #fff;
      border: 1px solid #555;
    }
    #settingsPanel {
      position: fixed;
      right: 20px;
      top: 100px;
      width: 200px;
      background: #f5f5f5;
      border: 1px solid #ccc;
      padding: 10px;
      border-radius: 8px;
    }
    body.dark-mode #settingsPanel {
      background: #2c2c2c;
      border-color: #555;
    }
    #settingsPanel button, #settingsPanel label {
      margin-bottom: 10px;
      width: 100%;
    }
/* Other user's message (normal, black) */
.other-message {
  font-weight: normal;
  color: black;
}
body.dark-mode .other-message {
  font-weight: normal;
  color: white;
}
.active-user {
  font-weight: bold;
  color: blue;
  text-transform: uppercase;
}
/* Default light mode style */
.chat-tab.active {
  font-weight: bold;
  color: black;
  background-color: ##e1e2e6; /* Dark white */
}
/* Dark mode override */
body.dark-mode .chat-tab.active {
  color: white;
  background-color: #333;
}
  </style>
</head>
<body>

<!-- Auth -->
<div id="authSection">
  <input id="email" placeholder="Email" /><br />
  <input id="password" type="password" placeholder="Password" /><br />
  <input id="displayName" placeholder="Username (register only)" /><br />
  <input id="profilePic" type="file" accept="png/*" /><br />
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
</div>
<!-- Chat -->
<div id="chatSection" class="hidden">
  <p class="welcome">Welcome, <span id="userDisplay"></span>! <button onclick="logout()">Logout</button></p>
    <p id="onlineCount" style="font-weight: bold; color: lightgreen;">People Online: 0</p>

  <div class="search-bar-container">
    <input id="targetUsername" placeholder="Enter username to start a chat" />
    <button id="startChatButton" onclick="startPrivateChat()">Start Chat</button>
  </div>

  <h4>Your Friends</h4>
  <ul id="friendsList"></ul>

  <!-- Group Chat UI -->
  <div style="margin-top: 20px;">
    <h4>Create Group Chat</h4>
    <input id="groupName" placeholder="Group Name" />
    <input id="groupMembers" placeholder="Comma-separated usernames" />
    <button onclick="createGroup()">Create Group</button>
  </div>

  <h4>Your Groups</h4>
  <ul id="groupList"></ul>

  <div id="chatTabs"></div>
  <div id="messages"></div>
  <div id="typingIndicator"></div>

  <input id="messageInput" placeholder="Type your message..." oninput="sendTypingStatus(true)" />
  <button onclick="sendMessage()">Send</button>
  <button onclick="clearChat()">Clear Chat</button>

  <div id="settingsPanel">
    <h4>Settings</h4>
    <button onclick="changePassword()">Change Password</button><br />
    <button onclick="deleteAccount()">Delete Account</button><br />
    <label>
      <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" />
      Dark Mode
    </label>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAqi9ei8fWTF4cIVlfYsdX0jA6WAAazW5s",
    authDomain: "chat-app-2-5894e.firebaseapp.com",
    databaseURL: "https://chat-app-2-5894e-default-rtdb.firebaseio.com",
    projectId: "chat-app-2-5894e",
    storageBucket: "chat-app-2-5894e.appspot.com",
    messagingSenderId: "993534384345",
    appId: "1:993534384345:web:1b7615224c5d8d457606c8",
    measurementId: "G-ELRMZ8WZ0C"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const usersRef = db.ref("users");
  const statusRef = db.ref("status");

statusRef.on("value", snapshot => {
  let onlineCount = 0;
  snapshot.forEach(child => {
    if (child.val().state === "online") {
      onlineCount++;
    }
  });
  document.getElementById("onlineCount").textContent = `People Online: ${onlineCount}`;
});

  const typingRef = db.ref("typing");

  let currentUser = null;
  let username = "";
  let profilePicURL = "";
  let currentChatUser = null;
  let currentGroupId = null;

  const messageInput = document.getElementById("messageInput");
  const messagesDiv = document.getElementById("messages");
  const typingIndicator = document.getElementById("typingIndicator");
  const chatTabs = document.getElementById("chatTabs");

  function clearChat() {
    messagesDiv.innerHTML = "";
    if (currentGroupId) {
      db.ref("groupMessages/" + currentGroupId).remove();
    } else if (currentChatUser) {
      const roomId = chatRoomId(username, currentChatUser.username);
      db.ref("messages/" + roomId).remove();
    }
  }

  function register() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    const uname = document.getElementById("displayName").value;
    const pic = document.getElementById("profilePic").files[0];
    if (!email || !pass || !uname) return alert("Fill all fields");
    auth.createUserWithEmailAndPassword(email, pass).then(cred => {
      if (pic) {
        const reader = new FileReader();
        reader.onload = () => usersRef.child(cred.user.uid).set({ username: uname, profilePic: reader.result });
        reader.readAsDataURL(pic);
      } else {
        usersRef.child(cred.user.uid).set({ username: uname, profilePic: "" });
      }
    }).catch(err => alert(err.message));
  }

  function login() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
  }

  function logout() {
  auth.signOut().then(() => {
    // Clear the profile picture from the UI after logout
    document.getElementById("userDisplay").innerHTML = 'You have logged out.';

    // Allow the user to change their profile picture while logged out
    document.getElementById("changePicSection").style.display = 'block';
  }).catch(err => alert('Logout failed: ' + err.message));
}

  function chatRoomId(u1, u2) {
    return [u1, u2].sort().join("_");
  }

  function startPrivateChat() {
    const targetName = document.getElementById("targetUsername").value.trim();
    if (!targetName || targetName === username) return;

    usersRef.once("value").then(snapshot => {
      let targetID = null, targetPic = "";
      snapshot.forEach(child => {
        if (child.val().username === targetName) {
          targetID = child.key;
          targetPic = child.val().profilePic;
        }
      });
      if (!targetID) return alert("User not found");
      currentChatUser = { id: targetID, username: targetName, pic: targetPic };
      currentGroupId = null;
      localStorage.setItem("lastChatUser", targetName);
      setupChatTab(targetName);
      loadMessages();
      usersRef.child(currentUser.uid).child("friends").child(targetID).set({ username: targetName, profilePic: targetPic });
      usersRef.child(targetID).child("friends").child(currentUser.uid).set({ username, profilePic: profilePicURL });
      loadFriendsList();
    });
  }

  function loadFriendsList() {
  const friendsList = document.getElementById("friendsList");
  friendsList.innerHTML = "";  // Clear existing list

  usersRef.child(currentUser.uid).child("friends").once("value").then(snapshot => {
    snapshot.forEach(child => {
      const friend = child.val();
      const li = document.createElement("li");
      li.innerHTML = `
        <img src="${friend.profilePic || 'https://via.placeholder.com/32'}"
             style="width:24px;height:24px;border-radius:50%;margin-right:5px;" />
        <span style="cursor:pointer;color:blue;" onclick="chatWithFriend('${friend.username}')">
          ${friend.username}
        </span>
        <button onclick="removeFriend('${child.key}', '${friend.username}')" 
                style="
                  margin-left:10px;
                  font-weight:bold;
                  font-size:0.52em;
                  text-transform:uppercase;
                  color:red;
                  background:none;
                  border: 1px solid black;
                  cursor:pointer;
                ">
          remove
        </button>
      `;
      friendsList.appendChild(li);
    });
  });
}


function removeFriend(friendId, friendUsername) {
  if (confirm(`Are you sure you want to remove ${friendUsername} from your friends list? This cannot be undone.`)) {
    usersRef.child(currentUser.uid).child("friends").child(friendId).remove()
      .then(() => {
        usersRef.child(friendId).child("friends").child(currentUser.uid).remove()
          .then(() => {
            alert(`${friendUsername} has been removed.`);
            loadFriendsList();
          })
          .catch(error => alert("Error removing friend from their list: " + error.message));
      })
      .catch(error => alert("Error removing friend: " + error.message));
  }
}

  function chatWithFriend(friendUsername) {
    document.getElementById("targetUsername").value = friendUsername;
    startPrivateChat();
  }

  function setupChatTab(name) {
    const tab = document.createElement("span");
    tab.className = "chat-tab active";
    tab.textContent = name;
    tab.onclick = () => {
      document.getElementById("targetUsername").value = name;
      startPrivateChat();
    };
    chatTabs.innerHTML = "";
    chatTabs.appendChild(tab);
  }

  function loadMessages() {
  messagesDiv.innerHTML = "";
  const roomId = chatRoomId(username, currentChatUser.username);
  const msgRef = db.ref("messages/" + roomId);
  msgRef.off();
  msgRef.on("child_added", snap => {
    const msg = snap.val();
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const el = document.createElement("div");
    el.className = "msg";
    const isUserMessage = msg.sender === username;  // Check if this message is from the current user
    el.innerHTML = `
      <img src="${msg.profilePic || 'https://via.placeholder.com/32'}" />
      <b class="${isUserMessage ? 'active-user' : ''}">${isUserMessage ? 'You' : msg.sender}:</b>&nbsp;

      <span class="${isUserMessage ? 'user-message' : 'other-message'}">${msg.text}</span>
      <span class="time">${time}</span>
    `;
    messagesDiv.appendChild(el);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
  typingRef.child(roomId).on("value", snap => {
    typingIndicator.textContent = snap.val() && snap.val() !== username ? "..." : "";
  });
}

  function sendMessage() {
    const text = messageInput.value.trim();
    if (!text) return;
    const msg = { sender: username, text, profilePic: profilePicURL, timestamp: Date.now() };
    if (currentGroupId) {
      db.ref("groupMessages/" + currentGroupId).push(msg);
    } else if (currentChatUser) {
      const roomId = chatRoomId(username, currentChatUser.username);
      db.ref("messages/" + roomId).push(msg);
      sendTypingStatus(false);
    }
    messageInput.value = "";
  }

  function sendTypingStatus(isTyping) {
    if (!currentChatUser) return;
    const roomId = chatRoomId(username, currentChatUser.username);
    typingRef.child(roomId).set(isTyping ? username : "");
    if (isTyping) setTimeout(() => typingRef.child(roomId).set(""), 3000);
  }

  function createGroup() {
    const name = document.getElementById("groupName").value.trim();
    const usernames = document.getElementById("groupMembers").value.split(",").map(u => u.trim()).filter(Boolean);
    if (!name || usernames.length < 2) return alert("Enter group name and at least 2 members.");
    usernames.push(username);
    usersRef.once("value").then(snap => {
      const members = {};
      snap.forEach(child => {
        if (usernames.includes(child.val().username)) {
          members[child.key] = true;
        }
      });
      if (Object.keys(members).length < 2) return alert("Some members not found.");
      db.ref("groups").push({ name, members }).then(() => {
        alert("Group created!");
        loadGroupList();
      });
    });
  }

  function loadGroupList() {
    const list = document.getElementById("groupList");

    // Step 1: Clear the existing group list (to prevent duplicates)
    list.innerHTML = ""; // Clears the old groups each time the function is called

    // Step 2: Fetch groups from Firebase (or wherever you store them)
    db.ref("groups").once("value").then(snap => {
        // Step 3: Loop over the groups and only append those that belong to the current user
        snap.forEach(groupSnap => {
            const group = groupSnap.val();
            const groupId = groupSnap.key;

            // Step 4: Check if the current user is a member of the group
            if (group.members && group.members[currentUser.uid]) {
                const li = document.createElement("li");

                // Step 5: Dynamically create the group name and the delete button
                li.innerHTML = `
                    <span style="cursor:pointer;color:green;" 
                        onclick="enterGroupChat('${groupId}', '${group.name}')">
                        ${group.name}
                    </span>
                    <button onclick="deleteGroupChat('${groupId}', '${group.name}')"
                        style="margin-left:10px; font-weight:bold; font-size:0.50em; text-transform:uppercase; color:red; background:none; border: 1px solid white; cursor:pointer;">
                        Delete
                    </button>
                `;
                
                // Step 6: Append the group to the list
                list.appendChild(li);
            }
        });
    }).catch(error => {
        console.error("Error loading group list: ", error);
    });
}

// New deleteGroup function
function deleteGroupChat(groupId, groupName) {
  if (confirm(`Are you sure you want to delete the group "${groupName}"? This action cannot be undone.`)) {
    db.ref("groups/" + groupId).remove()
      .then(() => {
        db.ref("groupMessages/" + groupId).remove();
        alert(`Group "${groupName}" has been deleted.`);
        loadGroupList();
        messagesDiv.innerHTML = "";
        chatTabs.innerHTML = "";
      })
      .catch(error => alert("Error deleting group: " + error.message));
  }
}

  function enterGroupChat(groupId, groupName) {
    currentGroupId = groupId;
    currentChatUser = null;
    chatTabs.innerHTML = `<span class="chat-tab active">${groupName}</span>`;
    messagesDiv.innerHTML = "";
    const msgRef = db.ref("groupMessages/" + groupId);
    msgRef.off();
    msgRef.on("child_added", snap => {
  const msg = snap.val();
  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const el = document.createElement("div");
  el.className = "msg";

  const isUserMessage = msg.sender === username;

  el.innerHTML = `
    <img src="${msg.profilePic || 'https://via.placeholder.com/32'}" />
    <b class="${isUserMessage ? 'active-user' : 'other-username'}">${isUserMessage ? 'You' : msg.sender}:</b>&nbsp;

    <span class="${isUserMessage ? 'user-message' : 'other-message'}">${msg.text}</span>
    <span class="time">${time}</span>
  `;

  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

    
  }

  function changePassword() {
    const email = prompt("Enter your email to receive a reset link:");
    if (email) auth.sendPasswordResetEmail(email).then(() => alert("Password reset sent!")).catch(err => alert(err.message));
  }

  function deleteAccount() {
    if (confirm("Delete account? This can't be undone.")) {
      usersRef.child(currentUser.uid).remove().then(() => {
        currentUser.delete().then(() => {
          alert("Account deleted.");
          logout();
        }).catch(err => alert("Re-login and try again."));
      });
    }
  }

  function toggleDarkMode() {
    const isDark = document.getElementById("darkModeToggle").checked;
    document.body.classList.toggle("dark-mode", isDark); // Toggle dark mode class
    localStorage.setItem("darkMode", isDark); // Save the state in localStorage
}

  window.addEventListener("load", () => {
    const dark = localStorage.getItem("darkMode") === "true";
    document.getElementById("darkModeToggle").checked = dark;
    document.body.classList.toggle("dark-mode", dark);
  });

  auth.onAuthStateChanged(user => {
  // If the user is logged in
  if (user) {
    currentUser = user;
    document.getElementById("authSection").classList.add("hidden");
    document.getElementById("chatSection").classList.remove("hidden");

    const userStatusRef = db.ref("/status/" + user.uid);
    const isOfflineForDatabase = {
      state: "offline",
      last_changed: firebase.database.ServerValue.TIMESTAMP,
    };
    const isOnlineForDatabase = {
      state: "online",
      last_changed: firebase.database.ServerValue.TIMESTAMP,
    };

    // Monitor connection state
    const connectedRef = db.ref(".info/connected");
    connectedRef.on("value", function (snap) {
      if (snap.val() === false) {
        return;
      }

      userStatusRef
        .onDisconnect()
        .set(isOfflineForDatabase)
        .then(() => {
          userStatusRef.set(isOnlineForDatabase);
        });
    });

    // Existing logic for fetching user details
    usersRef.child(user.uid).once("value").then(snap => {
      const data = snap.val();
      username = data.username;
      profilePicURL = data.profilePic || "";
      document.getElementById("userDisplay").textContent = username;
      const lastUser = localStorage.getItem("lastChatUser");
      if (lastUser) {
        document.getElementById("targetUsername").value = lastUser;
        startPrivateChat();
      }
      loadFriendsList();
      loadGroupList();
    });
  } else {
    // If the user is logged out
    currentUser = null;
    document.getElementById("authSection").classList.remove("hidden");
    document.getElementById("chatSection").classList.add("hidden");
  }
});


// Add event listener for the Enter key press
messageInput.addEventListener("keypress", function(event) {
  // Check if the key pressed is "Enter" (key code 13)
  if (event.key === "Enter" && !event.shiftKey) {  // !event.shiftKey ensures it doesn't trigger when Shift+Enter is pressed
    event.preventDefault();  // Prevent the default behavior of creating a new line
    sendMessage();  // Send the message when Enter is pressed
  }
});


</script>
<style>/* Default (light mode) border color */
#friendsList button {
  border: 1px solid black; /* Light mode border color */
}

/* Dark mode border color (increased specificity) */
body.dark-mode #friendsList button {
  border: 1px solid white !important; /* Dark mode border color */
}
</style>
</body>
</html>
