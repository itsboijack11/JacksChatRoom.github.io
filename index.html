<!DOCTYPE html>
<html lang="en">
<head> 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JF Chat Room</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico" />
  <style>

#globalChatBtn {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 20px;
    font-size: 16px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: background-color 0.3s;
}

#globalChatBtn:hover {
    background-color: #0056b3;
}

       
.profile-pic {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  vertical-align: middle;
  margin-left: 0px;
}

       
#friendsList button.remove-friend {
  background-color: none;
  color: red; 
}
       

#groupList button.delete-group {
  background-color: none; 
  color: red; 
}

body.dark-mode #groupList button.delete-group {
  background-color: none; 
  color: red; 
}
       

#groupList button.add-user {
  background-color: none; 
  color: black; 
}


body.dark-mode #groupList button.add-user {
  background-color: none; 
  color: white; 
}

       
.active-user {
    font-weight: bold;
    color: lightblue;
  }

  .other-username {
    font-weight: bold;
    color: lightblue;
  }

.user-message {
  font-weight: bold;
  color: black; 
}


body.dark-mode .user-message {
  color: white;
}


#messages img:not(.pasted-image), 
#friendsList img:not(.pasted-image) { 
  border-radius: 50%;
  border: 1px solid black;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.2);
}


body.dark-mode #messages img:not(.pasted-image),
body.dark-mode #friendsList img:not(.pasted-image) {
  border-color: white;
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.2);
}


#messages img.pasted-image {
  border: none;
  border-radius: 1px;
  max-width: 100%;
  height: auto;
  margin: 10px 0;
  box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
}

body.dark-mode #messages img.pasted-image {
  box-shadow: 0 0 4px rgba(255, 255, 255, 0.1);
}

body #messages img:not(.pasted-image),
body #friendsList img:not(.pasted-image) {
  border-radius: 50%;
  border: 0px solid black !important;
  box-shadow: 0 0 6px rgba(0, 0, 0, 0.2) !important;
}

body.dark-mode #messages img:not(.pasted-image),
body.dark-mode #friendsList img:not(.pasted-image) {
  border-color: white !important;
  box-shadow: 0 0 6px rgba(255, 255, 255, 0.2) !important;
}      
    body { font-family: Arial; max-width: 700px; margin: auto; padding: 20px; transition: background 0.3s, color 0.3s; }
    #messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-top: 10px; }
    #messageInput { width: 65%; }
    .hidden { display: none; }
    .chat-tab { cursor: pointer; padding: 5px; margin-right: 5px; background: #ddd; border-radius: 5px; display: inline-block; }
    .chat-tab.active { background: #bbb; }
    .msg { margin-bottom: 10px; display: flex; align-items: center; }
    .msg img { width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; }
    .time { font-size: 0.8em; color: #777; margin-left: 10px; }
    #typingIndicator { font-style: italic; color: #666; margin-top: 5px; height: 16px; }

    .search-bar-container {
      display: flex;
      justify-content: space-between;
      width: 50%;
      margin: 20px auto;
    }

    #targetUsername {
      flex: 1;
      padding: 5px;
    }
    #startChatButton {
      padding: 5px 10px;
      cursor: pointer;
    }
    #friendsList {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      padding: 10px 0;
    }
    #friendsList li {
      margin-right: 10px;
      list-style: none;
    }
    #friendsList img {
      vertical-align: middle;
    }
    .welcome {
      position: absolute;
      top: 20px;
      left: 20px;
    }
    body.dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    body.dark-mode #messages {
      background-color: #1e1e1e;
      border-color: #444;
    }
    body.dark-mode input,
    body.dark-mode button {
      background-color: #2c2c2c;
      color: #fff;
      border: 1px solid #555;
    }
    #settingsPanel {
  position: absolute;
  right: 20px;
  top: 100px;
  width: 200px;
  background: #f5f5f5; 
  border: 2px solid #ccc;
  padding: 10px;
  border-radius: 8px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 20px;
}
    body.dark-mode #settingsPanel {
  background: #2c2c2c; 
  border-color: #555;
}

.other-message {
  font-weight: normal;
  color: black;
}
body.dark-mode .other-message {
  font-weight: normal;
  color: white;
}
.active-user {
  font-weight: bold;
  color: blue;
  text-transform: uppercase;
}

.chat-tab.active {
  font-weight: bold;
  color: black;
  background-color: #e1e2e6; 
}

body.dark-mode .chat-tab.active {
  color: white;
  background-color: #333;
}

.modal {
    display: none; 
    position: fixed; 
    z-index: 1; 
    left: 0;
    top: 0;
    width: 100%; 
    height: 90%; 
    overflow: auto; 
    background-color: rgb(0,0,0); /
    background-color: rgba(0,0,0,0.4); 
}

.modal-content {
    background-color: #fefefe;
    margin: 15% auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%; 
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

#usernameToAdd {
    width: 90%;
    padding: 8px;
    margin: 10px 0;
}

   #friendsList button {
  border: 1px solid black; 
}


body.dark-mode #friendsList button {
  border: 1px solid white !important; 
}


#addUserModal {
    display: none; 
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5); 
    justify-content: center;
    align-items: center;
    z-index: 1000; 
}

.modal-content {
    background-color: black;
    padding: 20px;
    border-radius: 5px;
    width: 300px;
    text-align: center;
}

.close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 30px;
    color: #aaa;
    background: none;
    border: none;
    cursor: pointer;
}

.close-btn:hover {
    color: black;
}

    

#addUserButton {
    margin-top: 10px;
    padding: 10px;
    background-color: green;
    color: white;
    border: none;
    cursor: pointer;

}

#settingsPanel {
  max-height: 90vh;     
  overflow-y: auto;         
  padding: 20px;
  background-color: #222;  
  border-radius: 8px;
}

#settingsPanel button {
    padding: 10px;
    margin-bottom: 10px;
    font-size: 13px;
    width: 100%;
    cursor: pointer;
    border: none;
    border-radius: 5px;
}



#settingsPanel button:nth-child(2) {
  background-color: #FF9800;  
  color: white;
}



#settingsPanel label {
    display: flex;
    align-items: center;
    margin-top: 20px;
}

#settingsPanel input[type="checkbox"] {
    margin-right: 10px;
}

.modal {
  opacity: 0;
  transition: opacity 0.3s ease;
}
.modal.show {
  opacity: 1;
}

.loading-indicator {
   text-align: center;
   font-size: 14px;
   color: #888;
   margin: 10px 0;
}    

#settingsPanel {
  position: absolute;
  right: 20px;
  top: 100px;
  width: 200px;
  background: #f5f5f5 !important; 
  border: 2px solid #ccc;
  padding: 10px;
  border-radius: 8px;
  max-height: 90vh;
  overflow-y: auto;
}


body.dark-mode #settingsPanel {
  background: #2c2c2c !important; 
  border-color: #555;
}

#settingsPanel button {
  background-color: #dcdcdc;  
  color: black;  
}

body.dark-mode #settingsPanel button {
  background-color: black;  
  color: white;  
}


#changeUsernameButton {
  background-color: #dcdcdc !important;
  color: black !important;
}

body.dark-mode #changeUsernameButton {
  background-color: black !important;
  color: white !important;
}


.chat-tab {
  background-color: #f0f0f0;
  color: #000;
  cursor: pointer;
  padding: 5px 10px;  
  margin-right: 5px;
  border-radius: 5px;
  display: inline-block;
  font-weight: normal;  
  transition: background-color 0.2s ease, font-weight 0.2s ease;
}

.chat-tab:hover {
  background-color: #e0e0e0;  
}

body.dark-mode .chat-tab {
  background-color: #333;
  color: #fff;
}


.chat-tab.active {
  background-color: #bbb;
  font-weight: bold;  
  color: #007bff;  
}

body.dark-mode .chat-tab.active {
  background-color: #444;  
  color: #00bfff;  
}
  </style>
</head>
<body>
     
<button id="globalChatBtn" style="position: absolute; top: 10px; right: 10px; padding: 10px; background-color: blue; color: white; border: none; border-radius: 5px; cursor: pointer;">
    Global Chat
</button>
     
<div id="authSection">
  <input id="email" placeholder="Email" /><br />
  <input id="password" type="password" placeholder="Password" /><br />
  <input id="displayName" placeholder="Username (register only)" /><br />
  <input id="profilePic" type="file" accept="png/*" /><br />
  <button onclick="register()">Register</button>
  <button onclick="login()">Login</button>
</div>

<div id="chatSection" class="hidden">
  <p class="welcome">
  Welcome, <span id="userDisplay"></span>!
  <img id="profilePicDisplay" class="profile-pic" />

  <button onclick="logout()">Logout</button>
  </p>
  <p id="onlineCount" style="font-weight: bold; color: lightgreen;">People Online: 0</p>

  <div class="search-bar-container">
    <input id="targetUsername" placeholder="Enter username to start a chat" />
    <button id="startChatButton" onclick="startPrivateChat()">Start Chat</button>
  </div>

  <h4>Your Friends</h4>
  <ul id="friendsList"></ul>

  
  <div style="margin-top: 20px;">
    <h4>Create Group Chat</h4>
    <input id="groupName" placeholder="Group Name" />
    <input id="groupMembers" placeholder="Comma-separated usernames" />
    <button onclick="createGroup()">Create Group</button>
  </div>

  <h4>Your Groups</h4>
  <ul id="groupList"></ul>

  <div id="chatTabs"></div>
  <div id="messages"></div>
  <div id="typingIndicator"></div>
  <div id="toastContainer" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;">
  </div>
  <div id="addUserModal" style="display:none;">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal()">×</span>
        <h2>Add a User to the Group</h2>
        <input type="text" id="usernameToAdd" placeholder="Enter username" />
        <button onclick="addUserToGroup()">Add User</button>
    </div>
</div>

  <input id="messageInput" placeholder="Type your message..." oninput="sendTypingStatus(true)" />
  <button onclick="sendMessage()">Send</button>
  <button onclick="clearChat()">Clear Chat</button>

  <div id="settingsPanel">
    <h4>Settings</h4>

    
    <button id="changeUsernameButton" onclick="changeUsername()">Change Username</button>

    
    <button id="changePasswordButton" onclick="changePassword()">Change Password</button><br />

    
    <button onclick="deleteAccount()">Delete Account</button><br />

    
    <label>
      <input type="checkbox" id="darkModeToggle" onchange="toggleDarkMode()" />
      Dark Mode
 </label>

  <label>
  <input type="checkbox" id="profanityFilterToggle" onchange="toggleProfanityFilter()" />
  Profanity Filter
</label>

  
  </div>


<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging-compat.js"></script>

<script>


  const firebaseConfig = {
    apiKey: "AIzaSyAqi9ei8fWTF4cIVlfYsdX0jA6WAAazW5s",
    authDomain: "chat-app-2-5894e.firebaseapp.com",
    databaseURL: "https://chat-app-2-5894e-default-rtdb.firebaseio.com",
    projectId: "chat-app-2-5894e",
    storageBucket: "chat-app-2-5894e.appspot.com",
    messagingSenderId: "993534384345",
    appId: "1:993534384345:web:1b7615224c5d8d457606c8",
    measurementId: "G-ELRMZ8WZ0C"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const usersRef = db.ref("users");
  const statusRef = db.ref("status");

statusRef.on("value", snapshot => {
  let onlineCount = 0;
  snapshot.forEach(child => {
    if (child.val().state === "online") {
      onlineCount++;
    }
  });
  document.getElementById("onlineCount").textContent = `People Online: ${onlineCount}`;
});

  const typingRef = db.ref("typing");

  let currentUser = null;
  let username = "";
  let profilePicURL = "";
  let currentChatUser = null;
  let currentGroupId = null;

  const messageInput = document.getElementById("messageInput");
  const messagesDiv = document.getElementById("messages");
  const typingIndicator = document.getElementById("typingIndicator");
  const chatTabs = document.getElementById("chatTabs");

  function openModal() {
  document.getElementById("addUserModal").classList.add("show");
}
function closeModal() {
  document.getElementById("addUserModal").classList.remove("show");
}
     
       function clearChat() {
    messagesDiv.innerHTML = "";
    if (currentGroupId) {
      db.ref("groupMessages/" + currentGroupId).remove();
    } else if (currentChatUser) {
      const roomId = chatRoomId(username, currentChatUser.username);
      db.ref("messages/" + roomId).remove();
    }
  }
function changeUsername() {
    
    const newUsername = prompt("Enter your new username:");
    
    if (newUsername && newUsername.trim() !== "") {
        
        db.ref("users").orderByChild("username").equalTo(newUsername).once("value")
            .then(snapshot => {
                if (snapshot.exists()) {
                    
                    alert("This username is already taken. Please choose another one.");
                } else {
                    
                    usersRef.child(currentUser.uid).update({ username: newUsername })
                        .then(() => {
                            alert("Username successfully updated!");
                            
                            document.getElementById("userDisplay").textContent = newUsername;
                        })
                        .catch(error => {
                            alert("Error updating username: " + error.message);
                        });
                }
            })
            .catch(error => {
                alert("Error checking username: " + error.message);
            });
    } else {
        alert("Username cannot be empty.");
    }
}

    let isProfanityFilterEnabled = false;

// List of bad words to be filtered
const badWords = ['fuck', 'shit', 'pussy', 'nigga', 'nigger', 'n1gger', 'bitch', 'b1tch', 'fucc', 'fuc', 'fukk', 'fukc', 'whore', 'hoe', 'pssy', 'pusy', 'sh1t', 'dick', 'd1ck', 'cunt', 'cuntt', 'fucking', 'fcking', 'fukking', 'shiti', 'motherfucker', 'motherfuccer', 'motherfcker', 'motherfukker', 'n1gga', 'fucker', 'fuker', 'fukka', 'fuccer', 'fuckin', 'fkin', 'cunty'];  


function toggleProfanityFilter() {
  const checkbox = document.getElementById('profanityFilterToggle');
  isProfanityFilterEnabled = checkbox.checked;
  localStorage.setItem('profanityFilter', isProfanityFilterEnabled);  
  console.log("Profanity filter enabled:", isProfanityFilterEnabled);
}


function filterProfanity(text) {
  if (!isProfanityFilterEnabled) return text;

  const sortedBadWords = [...badWords].sort((a, b) => b.length - a.length);

  for (const badWord of sortedBadWords) {
    // Use word boundary if needed; otherwise, ensure full match
    const regex = new RegExp(`\\b${badWord}\\b`, 'gi');
    text = text.replace(regex, match => {
      const visible = match.slice(0, 2);
      const stars = '*'.repeat(match.length - 2);
      return visible + stars;
    });
  }

  return text;
}






function loadProfanityFilterSetting() {
  const savedFilterSetting = localStorage.getItem('profanityFilter');
  
  if (savedFilterSetting !== null) {
    isProfanityFilterEnabled = savedFilterSetting === 'true';  // Convert the string back to a boolean
    document.getElementById('profanityFilterToggle').checked = isProfanityFilterEnabled;  // Update the checkbox
  }
}

function clearMessages() {
  messagesDiv.innerHTML = ""; // Clear previous messages in the chat window
}

     
let currentChatName = null; // Track the current chat being viewed

function openChat(name) {
  // If the same chat is clicked again, do nothing
  if (currentChatName === name) return;

  // Track the current chat name
  currentChatName = name;

  // Show a loading spinner or a blank area to indicate loading
  document.getElementById("loadingSpinner").classList.remove("hidden");
  
  // Optionally, you can hide the messages section or show a loading indicator in the messages div
  messagesDiv.innerHTML = "";  // Clear current messages immediately

  // Load the messages for the new chat (this triggers the loading of messages in the background)
  loadMessages(name);
  
  // Hide the spinner once the new messages are loaded (this will happen in your existing loadMessages logic)
  document.getElementById("loadingSpinner").classList.add("hidden");
}




     
  function register() {
    const email = document.getElementById("email").value;
    const pass = document.getElementById("password").value;
    const uname = document.getElementById("displayName").value;
    const pic = document.getElementById("profilePic").files[0];
    if (!email || !pass || !uname) return alert("Fill all fields");
    auth.createUserWithEmailAndPassword(email, pass).then(cred => {
      if (pic) {
        const reader = new FileReader();
        reader.onload = () => usersRef.child(cred.user.uid).set({ username: uname, profilePic: reader.result });
        reader.readAsDataURL(pic);
      } else {
        usersRef.child(cred.user.uid).set({ username: uname, profilePic: "" });
      }
    }).catch(err => alert(err.message));
  }

  function login() {
  const email = document.getElementById("email").value;
  const pass = document.getElementById("password").value;
  const pic = document.getElementById("profilePic").files[0];

  auth.signInWithEmailAndPassword(email, pass)
    .then(cred => {
      if (pic) {
        const reader = new FileReader();
        reader.onload = () => {
          
          usersRef.child(cred.user.uid).update({
            profilePic: reader.result
          });
        };
        reader.readAsDataURL(pic);
      }
    })
    .catch(err => alert(err.message));
}

function logout() {
  if (auth.currentUser) {
    auth.signOut()
      .then(() => {
        console.log("User logged out.");
        
        
        const chatSection = document.getElementById("chatSection");
        const authSection = document.getElementById("authSection");
        
        if (chatSection) {
          chatSection.classList.add("hidden");
        }
        
        if (authSection) {
          authSection.classList.remove("hidden");
        }

        
        currentUser = null;
        currentChatUser = null;
        currentGroupId = null;
        
        
      })
      .catch(error => {
        console.error("Logout failed:", error.message);
      });
  }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.classList.add('toast');
    toast.classList.add(type);  // Add the type for different styles (info, success, error, etc.)

    toast.innerHTML = `
        <div style="background-color: ${getToastBgColor(type)}; color: white; padding: 10px 20px; border-radius: 5px; max-width: 300px;">
            <span>${message}</span>
        </div>
    `;
    
    // Append the toast to the container
    const toastContainer = document.getElementById('toastContainer');
    toastContainer.appendChild(toast);

    // Auto-hide the toast after 3 seconds
    setTimeout(() => {
        toastContainer.removeChild(toast);
    }, 3000);
}

function getToastBgColor(type) {
    switch (type) {
        case 'success':
            return 'green';
        case 'error':
            return 'red';
        case 'info':
            return 'blue';
        case 'warning':
            return 'orange';
        default:
            return 'gray';
    }
}



  function chatRoomId(u1, u2) {
    return [u1, u2].sort().join("_");
  }

  function startPrivateChat() {
    const targetName = document.getElementById("targetUsername").value.trim();
    if (!targetName || targetName === username) return;

    usersRef.once("value").then(snapshot => {
      let targetID = null, targetPic = "";
      snapshot.forEach(child => {
        if (child.val().username === targetName) {
          targetID = child.key;
          targetPic = child.val().profilePic;
        }
      });
      if (!targetID) return alert("User not found");
      currentChatUser = { id: targetID, username: targetName, pic: targetPic };
      currentGroupId = null;
      localStorage.setItem("lastChatUser", targetName);
      setupChatTab(targetName);
      loadMessages();
      usersRef.child(currentUser.uid).child("friends").child(targetID).set({ username: targetName, profilePic: targetPic });
      usersRef.child(targetID).child("friends").child(currentUser.uid).set({ username, profilePic: profilePicURL });
      loadFriendsList();
    });
  }

  function loadFriendsList() {
  const friendsList = document.getElementById("friendsList");
  friendsList.innerHTML = "";  

  usersRef.child(currentUser.uid).child("friends").once("value").then(snapshot => {
    snapshot.forEach(child => {
      const friend = child.val();
      const li = document.createElement("li");
      li.innerHTML = `
        <img src="${friend.profilePic || 'https://via.placeholder.com/32'}"
             style="width:24px;height:24px;border-radius:50%;margin-right:5px;" />
        <span style="cursor:pointer;color:blue;" onclick="chatWithFriend('${friend.username}')">
          ${friend.username}
        </span>
        <button onclick="removeFriend('${child.key}', '${friend.username}')"
    class="remove-friend"
    style="margin-left:10px; font-weight:bold; font-size:0.52em; text-transform:uppercase; cursor:pointer;">
    Remove
</button>
      `;
      friendsList.appendChild(li);
    });
  });
}


function removeFriend(friendId, friendUsername) {
  if (confirm(`Are you sure you want to remove ${friendUsername} from your friends list? This cannot be undone.`)) {
    usersRef.child(currentUser.uid).child("friends").child(friendId).remove()
      .then(() => {
        usersRef.child(friendId).child("friends").child(currentUser.uid).remove()
          .then(() => {
            alert(`${friendUsername} has been removed.`);
            loadFriendsList();
          })
          .catch(error => alert("Error removing friend from their list: " + error.message));
      })
      .catch(error => alert("Error removing friend: " + error.message));
  }
}

  function chatWithFriend(friendUsername) {
    document.getElementById("targetUsername").value = friendUsername;
    startPrivateChat();
  }

function setupChatTab(name) {
  const existingTab = Array.from(chatTabs.children).find(tab => tab.textContent === name);
  if (existingTab) return;

  const tab = document.createElement("span");
  tab.className = "chat-tab";
  tab.textContent = name;

  // Handle tab click
  tab.onclick = () => {
    document.getElementById("targetUsername").value = name;
    startPrivateChat(); // Start the private chat
    setActiveChatTab(name); // Set the clicked tab as active
  };

  chatTabs.appendChild(tab);

  // Save to localStorage
  const savedTabs = JSON.parse(localStorage.getItem("chatTabs") || "[]");
  if (!savedTabs.includes(name)) {
    savedTabs.push(name);
    localStorage.setItem("chatTabs", JSON.stringify(savedTabs));
  }
}

// Function to set the clicked tab as active and remove the active class from others
function setActiveChatTab(name) {
  // Remove the active class from all chat tabs
  const tabs = document.querySelectorAll('.chat-tab');
  tabs.forEach(tab => tab.classList.remove('active'));

  // Add the active class to the clicked tab
  const activeTab = Array.from(tabs).find(tab => tab.textContent === name);
  if (activeTab) {
    activeTab.classList.add('active');
  }
}




  let lastMessageKey = null;
const messagesPerPage = 10;  
let isAtBottom = true;  

function loadMessages() {
  messagesDiv.innerHTML = "";  
  const roomId = chatRoomId(username, currentChatUser.username);
  const msgRef = db.ref("messages/" + roomId);

  
  msgRef.off("child_added");

  msgRef.limitToLast(messagesPerPage).on("child_added", snap => {
    const msg = snap.val();
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    const el = document.createElement("div");
    el.className = "msg";
    const isUserMessage = msg.sender === username;
    el.innerHTML = `
      <img src="${msg.profilePic || 'https://via.placeholder.com/32'}" />
      <b class="${isUserMessage ? 'active-user' : ''}">${isUserMessage ? 'You' : msg.sender}:</b>&nbsp;
      <span class="${isUserMessage ? 'user-message' : 'other-message'}" style="word-break: break-word;" >${filterProfanity(msg.text)}</span>
      <span class="time">${time}</span>
    `;
    messagesDiv.appendChild(el);  

    
    if (isAtBottom) {
      messagesDiv.scrollTop = messagesDiv.scrollHeight;  
    }

    lastMessageKey = snap.key;  
  });

  
  typingRef.child(roomId).on("value", snap => {
    typingIndicator.textContent = snap.val() && snap.val() !== username ? "..." : "";
  });

  
  messagesDiv.addEventListener('scroll', () => {
    
    if (messagesDiv.scrollTop === 0) {
      isAtBottom = false;
      loadOlderMessages(roomId);
    } else {
      
      isAtBottom = messagesDiv.scrollHeight - messagesDiv.scrollTop === messagesDiv.clientHeight;
    }
  });
}


function restoreChatTabs() {
  const savedTabs = JSON.parse(localStorage.getItem("chatTabs") || "[]");
  savedTabs.forEach(name => setupChatTab(name));
}




function sendMessage() {
  // Load profanity filter setting and restore chat tabs
  loadProfanityFilterSetting();
  restoreChatTabs();

  let text = messageInput.value.trim();  

  if (!text) return;  // Don't send empty messages

  text = filterProfanity(text);  // Apply profanity filter

  const msg = { 
    sender: username, 
    text, 
    profilePic: profilePicURL, 
    timestamp: Date.now() 
  };

  // Check if the current group is the global chat
  if (currentGroupId === globalChatId) {
    db.ref("globalChatMessages").push(msg);  // Send message to global chat
  } else if (currentGroupId) {
    // If it's a group chat
    db.ref("groupMessages/" + currentGroupId).push(msg);
  } else if (currentChatUser) {
    // If it's a private chat with a user
    const roomId = chatRoomId(username, currentChatUser.username);
    db.ref("messages/" + roomId).push(msg);
    sendTypingStatus(false);  // Stop typing status
  }

  messageInput.value = "";  // Clear input field after sending
}
     window.onload = function() {
  loadProfanityFilterSetting(); 
restoreChatTabs();

}

 let typingTimeout;
function sendTypingStatus(isTyping) {
  if (!currentChatUser) return;
  const roomId = chatRoomId(username, currentChatUser.username);

  clearTimeout(typingTimeout); 
  typingTimeout = setTimeout(() => {
    typingRef.child(roomId).set(isTyping ? username : "");
  }, 900); 
}

  function createGroup() {
    const name = document.getElementById("groupName").value.trim();
    const usernames = document.getElementById("groupMembers").value.split(",").map(u => u.trim()).filter(Boolean);
    if (!name || usernames.length < 2) return alert("Enter group name and at least 2 members.");
    usernames.push(username);
    usersRef.once("value").then(snap => {
      const members = {};
      snap.forEach(child => {
        if (usernames.includes(child.val().username)) {
          members[child.key] = true;
        }
      });
      if (Object.keys(members).length < 2) return alert("Some members not found.");
      db.ref("groups").push({ name, members }).then(() => {
        alert("Group created!");
        loadGroupList();
      });
    });
  }

 function loadGroupList() {
    const list = document.getElementById("groupList");
    list.innerHTML = ""; 

    db.ref("groups").once("value").then(snap => {
        snap.forEach(groupSnap => {
            const group = groupSnap.val();
            const groupId = groupSnap.key;

            
            if (group.members && group.members[currentUser.uid]) {
                const li = document.createElement("li");

                
                li.innerHTML = `
                    <span style="cursor:pointer;color:green;" 
                        onclick="enterGroupChat('${groupId}', '${group.name}')">
                        ${group.name}
                    </span>
                    <button onclick="deleteGroupChat('${groupId}', '${group.name}')"
    class="delete-group"
    style="margin-left:10px; font-weight:bold; font-size:0.52em; text-transform:uppercase; cursor:pointer;">
    Delete
</button>
                    <button onclick="handleAddUserClick('${groupId}')"
    class="add-user"
    style="margin-left:10px; font-weight:bold; font-size:0.52em; text-transform:uppercase; cursor:pointer;">
    +
</button>
                `;
                
                
                list.appendChild(li);
            }
        });
    }).catch(error => {
        console.error("Error loading group list: ", error);
    });
}



function deleteGroupChat(groupId, groupName) {
  if (confirm(`Are you sure you want to delete the group "${groupName}"? This action cannot be undone.`)) {
    db.ref("groups/" + groupId).remove()
      .then(() => {
        db.ref("groupMessages/" + groupId).remove();
        alert(`Group "${groupName}" has been deleted.`);
        loadGroupList();
        messagesDiv.innerHTML = "";
        chatTabs.innerHTML = "";
      })
      .catch(error => alert("Error deleting group: " + error.message));
  }
}

  function enterGroupChat(groupId, groupName) {
    currentGroupId = groupId;
    currentChatUser = null;
    chatTabs.innerHTML = `<span class="chat-tab active">${groupName}</span>`;
    messagesDiv.innerHTML = "";
    const msgRef = db.ref("groupMessages/" + groupId);
    msgRef.off();
    msgRef.on("child_added", snap => {
  const msg = snap.val();
  const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  const el = document.createElement("div");
  el.className = "msg";

  const isUserMessage = msg.sender === username;

  el.innerHTML = `
    <img src="${msg.profilePic || 'https://via.placeholder.com/32'}" />
    <b class="${isUserMessage ? 'active-user' : 'other-username'}">${isUserMessage ? 'You' : msg.sender}:</b>&nbsp;

    <span class="${isUserMessage ? 'user-message' : 'other-message'}" style="word-break: break-word;" >${filterProfanity(msg.text)}</span>

    <span class="time">${time}</span>
  `;

  messagesDiv.appendChild(el);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
});

    
  }

  function changePassword() {
    const email = prompt("Enter your email to receive a reset link:");
    if (email) auth.sendPasswordResetEmail(email).then(() => alert("Password reset sent!")).catch(err => alert(err.message));
  }

  function deleteAccount() {
    if (confirm("Delete account? This can't be undone.")) {
      usersRef.child(currentUser.uid).remove().then(() => {
        currentUser.delete().then(() => {
          alert("Account deleted.");
          logout();
        }).catch(err => alert("Re-login and try again."));
      });
    }
  }
     
function displayMessage(msg) {
  const messagesContainer = document.getElementById('messages');
  if (!messagesContainer) return;

  // Create a new message container
  const messageElement = document.createElement('div');
  messageElement.classList.add('msg');

  // If this message is from the user, highlight it differently (optional)
  const isUserMessage = msg.sender === username;
  messageElement.classList.add(isUserMessage ? 'user-message' : 'other-message');

  // Sender element
  const senderElement = document.createElement('strong');
  senderElement.textContent = msg.sender + ': ';

  // Text element with profanity filter
  const textElement = document.createElement('span');
  textElement.textContent = filterProfanity(msg.text);

  // Optional: Add timestamp (if available)
  if (msg.timestamp) {
    const timestampElement = document.createElement('span');
    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    timestampElement.classList.add('time');
    timestampElement.textContent = ` (${time})`;
    messageElement.appendChild(timestampElement);
  }

  // Append the sender and text to the message element
  messageElement.appendChild(senderElement);
  messageElement.appendChild(textElement);

  // Append message to the container
  messagesContainer.appendChild(messageElement);

  // Auto-scroll to the bottom if user is at the bottom
  messagesContainer.scrollTop = messagesContainer.scrollHeight;
}


  
function toggleDarkMode() {
    const isDark = document.getElementById("darkModeToggle").checked;
    document.body.classList.toggle("dark-mode", isDark); 
    localStorage.setItem("darkMode", isDark);  
}



window.addEventListener("load", () => {
    const dark = localStorage.getItem("darkMode") === "true";
    document.getElementById("darkModeToggle").checked = dark;
    document.body.classList.toggle("dark-mode", dark);
});


function handleAddUserClick(groupId) {
  
    currentGroupId = groupId;

    
    document.getElementById("addUserModal").style.display = "block";
}

function closeModal() {
    
    document.getElementById("addUserModal").style.display = "none";
}

// Preload messages for the new chat room before the user clicks it
function preloadChatMessages(name) {
  // This function could be triggered when the user hovers over the friend’s name or on some other event
  const roomId = chatRoomId(username, name);
  const msgRef = db.ref("messages/" + roomId).limitToLast(10);  // Preload last 10 messages, for example

  msgRef.once("value", snapshot => {
    const messages = snapshot.val();
    // Store the preloaded messages in memory or localStorage for fast retrieval when the user switches to this chat
    localStorage.setItem(`chatMessages_${roomId}`, JSON.stringify(messages));
  });
}


 

function addUserToGroup() {
    const usernameToAdd = document.getElementById("usernameToAdd").value.trim();

    if (!usernameToAdd) {
        alert("Please enter a username.");
        return;
    }

    
    db.ref("users").orderByChild("username").equalTo(usernameToAdd).once("value")
    .then(snapshot => {
        const userData = snapshot.val();
        
        if (userData) {
            
            const userId = Object.keys(userData)[0];

            
            db.ref("groups/" + currentGroupId + "/members/" + userId).set(true)
            .then(() => {
                alert(`${usernameToAdd} has been added to the group.`);
                closeModal(); 
            })
            .catch(error => {
                alert("Error adding user: " + error.message);
            });
        } else {
            alert("User not found.");
        }
    }).catch(error => {
        alert("Error checking username: " + error.message);
    });
}
     
  window.addEventListener("load", () => {
    const dark = localStorage.getItem("darkMode") === "true";
    document.getElementById("darkModeToggle").checked = dark;
    document.body.classList.toggle("dark-mode", dark);
  });

  auth.onAuthStateChanged(user => {
  
  if (user) {
    currentUser = user;
    document.getElementById("authSection").classList.add("hidden");
    document.getElementById("chatSection").classList.remove("hidden");

    // Show Global Chat button when logged in
    document.getElementById("globalChatBtn").style.display = 'block';

    const userStatusRef = db.ref("/status/" + user.uid);
    const isOfflineForDatabase = {
      state: "offline",
      last_changed: firebase.database.ServerValue.TIMESTAMP,
    };
    const isOnlineForDatabase = {
      state: "online",
      last_changed: firebase.database.ServerValue.TIMESTAMP,
    };

    const connectedRef = db.ref(".info/connected");
    connectedRef.on("value", function (snap) {
      if (snap.val() === false) {
        return;
      }

      userStatusRef
        .onDisconnect()
        .set(isOfflineForDatabase)
        .then(() => {
          userStatusRef.set(isOnlineForDatabase);
        });
    });

    usersRef.child(user.uid).once("value").then(snap => {
      const data = snap.val();
      username = data.username;
      profilePicURL = data.profilePic || "";
      document.getElementById("userDisplay").textContent = username;
      document.getElementById("profilePicDisplay").src = profilePicURL || "https://via.placeholder.com/32";
      const lastUser = localStorage.getItem("lastChatUser");
      if (lastUser) {
        document.getElementById("targetUsername").value = lastUser;
        startPrivateChat();
      }
      loadFriendsList();
      loadGroupList();
    });

  } else {
    currentUser = null;
    document.getElementById("authSection").classList.remove("hidden");
    document.getElementById("chatSection").classList.add("hidden");

    // Hide Global Chat button when logged out
    document.getElementById("globalChatBtn").style.display = 'none';
  }
});



messageInput.addEventListener("keypress", function(event) {
  
  if (event.key === "Enter" && !event.shiftKey) { 
    event.preventDefault();
    sendMessage();  
  }
});

messageInput.addEventListener("paste", async function (event) {
  const items = event.clipboardData.items;
  for (const item of items) {
    if (item.type.startsWith("image/")) {
      const file = item.getAsFile();
      if (file) {
        const storageRef = storage.ref(`chat_images/${Date.now()}_${file.name}`);
        const uploadTask = storageRef.put(file);
        
        uploadTask.on("state_changed", null, console.error, () => {
          uploadTask.snapshot.ref.getDownloadURL().then(url => {
            const msg = {
              sender: username,
              text: `<img src="${url}" class="pasted-image" />`,
              profilePic: profilePicURL,
              timestamp: Date.now()
            };

            if (currentGroupId) {
              db.ref("groupMessages/" + currentGroupId).push(msg);
            } else if (currentChatUser) {
              const roomId = chatRoomId(username, currentChatUser.username);
              db.ref("messages/" + roomId).push(msg);
              sendTypingStatus(false);
            }
          });
        });
      }
    }
  }
});

let globalChatId = 'global_chat';  // Define a unique room ID for global chat

// Event listener for the Global Chat button
document.getElementById("globalChatBtn").addEventListener("click", function() {
    // Switch to global chat room
    currentGroupId = globalChatId;
    currentChatUser = null; // Clear current chat user

    // Set up the global chat interface
    chatTabs.innerHTML = `<span class="chat-tab active">Global Chat</span>`;
    messagesDiv.innerHTML = ""; // Clear messages
    loadGlobalChatMessages();  // Load messages for the global chat room
});

// Function to load global chat messages
function loadGlobalChatMessages() {
    const msgRef = db.ref("globalChatMessages");  // Define a location for global chat messages in Firebase

    // Listen for new messages added to the global chat
    msgRef.off("child_added");
    msgRef.limitToLast(10).on("child_added", snap => {
        const msg = snap.val();
        const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        const el = document.createElement("div");
        el.className = "msg";
        const isUserMessage = msg.sender === username;
        el.innerHTML = `
            <img src="${msg.profilePic || 'https://via.placeholder.com/32'}" />
            <b class="${isUserMessage ? 'active-user' : ''}">${isUserMessage ? 'You' : msg.sender}:</b>&nbsp;
            <span class="${isUserMessage ? 'user-message' : 'other-message'}" style="word-break: break-word;" >${filterProfanity(msg.text)}</span>
            <span class="time">${time}</span>
        `;
        messagesDiv.appendChild(el);

        // Auto-scroll to the bottom if user is at the bottom
        if (isAtBottom) {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    });
}

// Send a message to the Global Chat
function sendGlobalChatMessage() {
    let text = messageInput.value.trim();  
    if (!text) return;  

    text = filterProfanity(text);

    const msg = { 
        sender: username, 
        text, 
        profilePic: profilePicURL, 
        timestamp: Date.now() 
    };

    db.ref("globalChatMessages").push(msg);  // Push message to the global chat

    messageInput.value = "";  // Clear input after sending
}

// Listen for the "Enter" key to send the global chat message
messageInput.addEventListener("keypress", function(event) {
    if (event.key === "Enter" && !event.shiftKey) {  // Only send message when "Enter" key is pressed
        event.preventDefault();
        sendGlobalChatMessage();  // Send message to global chat
    }
});

     
</script>


     
</body>
</html>
